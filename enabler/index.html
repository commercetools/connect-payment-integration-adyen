<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + TS</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <script>
      var __VITE_CTP_AUTH_URL__ =
        !"%VITE_CTP_AUTH_URL%".startsWith("%") && "%VITE_CTP_AUTH_URL%";
      var __VITE_CTP_API_URL__ =
        !"%VITE_CTP_API_URL%".startsWith("%") && "%VITE_CTP_API_URL%";
      var __VITE_CTP_SESSION_URL__ =
        !"%VITE_CTP_SESSION_URL%".startsWith("%") && "%VITE_CTP_SESSION_URL%";
      var __VITE_CTP_CLIENT_ID__ =
        !"%VITE_CTP_CLIENT_ID%".startsWith("%") && "%VITE_CTP_CLIENT_ID%";
      var __VITE_CTP_CLIENT_SECRET__ =
        !"%VITE_CTP_CLIENT_SECRET%".startsWith("%") &&
        "%VITE_CTP_CLIENT_SECRET%";
      var __VITE_CTP_PROJECT_KEY__ =
        !"%VITE_CTP_PROJECT_KEY%".startsWith("%") && "%VITE_CTP_PROJECT_KEY%";
      var __VITE_PROCESSOR_URL__ =
        !"%VITE_PROCESSOR_URL%".startsWith("%") && "%VITE_PROCESSOR_URL%";
    </script>
    <script src="dev-utils/session.js"></script>
    <script src="dev-utils/checkout.js"></script>
  </head>
  <body>
    <main role="main">
      <section class="jumbotron text-center">
        <div class="container">
          <form action="/action_page.php">
            <div class="text-center mb-4">
              <h1 class="h3 mb-3 font-weight-normal">Dev Site</h1>
              <p>Use this site for development purposes</p>
            </div>
            <div class="row">
              <div class="form-group col-md-6">
                <div>
                  <label for="cartId">Cart ID:</label>
                  <input
                    type="text"
                    class="form-control"
                    id="cartId"
                    value="b525a480-a757-4896-8289-44ce333cf5ab"
                  />
                </div>
              </div>
              <div class="form-group col-md-6">
                <label for="paymentMethod">Payment Method:</label>
                <select
                  class="form-control"
                  id="paymentMethod"
                  required
                ></select>
              </div>
            </div>
            <button
              id="createCheckout"
              class="btn btn-lg btn-primary btn-block"
              type="submit"
            >
              Create checkout
            </button>
          </form>
        </div>
      </section>

      <div class="album py-5 bg-light">
        <div class="container">
          <script type="module">
            import { Enabler } from "/src/main.ts";

            document.addEventListener("DOMContentLoaded", async () => {
              const paymentMethodSelect =
                document.getElementById("paymentMethod");
              const response = await fetch("http://localhost:9002/jwt/token", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  iss: "https://issuer.com",
                  sub: "test-sub",
                  "https://issuer.com/claims/project_key": `${__VITE_CTP_PROJECT_KEY__}`,
                }),
              });

              const jsonWebToken = await response.json();

              const res = await fetch(
                `${__VITE_PROCESSOR_URL__}/operations/payment-components`,
                {
                  method: "GET",
                  headers: {
                    Authorization: `Bearer ${jsonWebToken.token}`,
                  },
                }
              );
              const paymentMethods = await res.json();
              paymentMethods.components.forEach((method) => {
                const option = document.createElement("option");
                option.value = method.type;
                option.textContent = method.type;
                paymentMethodSelect.appendChild(option);
              });
              paymentMethods.dropins.forEach((method) => {
                const option = document.createElement("option");
                option.value = `${method.type}`;
                option.textContent = `dropin-${method.type}`;
                paymentMethodSelect.appendChild(option);
              });
              paymentMethods.express.forEach((method) => {
                const option = document.createElement("option");
                option.value = `${method.type}`;
                option.textContent = `express-${method.type}`;
                paymentMethodSelect.appendChild(option);
              });

              const optionStoredPaymentMethods =
                document.createElement("option");
              optionStoredPaymentMethods.value = `stored-payment-methods`;
              optionStoredPaymentMethods.textContent = `Use a stored-payment-method that is associated with the customerId set on the cart`;
              paymentMethodSelect.appendChild(optionStoredPaymentMethods);
            });

            document
              .getElementById("createCheckout")
              .addEventListener("click", async (event) => {
                event.preventDefault();
                const cartId = document.getElementById("cartId").value;
                ckoCartId = cartId;

                const paymentMethodSelect = document.getElementById("paymentMethod");
                const selectedValue = paymentMethodSelect.value;
                const selectedText = paymentMethodSelect.options[paymentMethodSelect.selectedIndex].text;

                const isDropIn = selectedText.startsWith("dropin");
                const isExpress = selectedText.startsWith("express");
                const sessionId = await getSessionId(cartId, isDropIn);

                const enabler = new Enabler({
                  processorUrl: __VITE_PROCESSOR_URL__,
                  sessionId: sessionId,
                  currencyCode: "EUR",
                  countryCode: 'DE',
                  onComplete: ({ isSuccess, paymentReference }) => {
                    console.log("onComplete", { isSuccess, paymentReference });
                  },
                  onError: (err) => {
                    console.error("onError", err);
                  },
                });

                let builder;

                const isStoredPaymentMethodSelected =
                  selectedValue === "stored-payment-methods";
                const allowedStoredPaymentMethods = ["card"]; // expand with more payment methods when they are supported
                const paymentMethodTypeToUseForSPM =
                  allowedStoredPaymentMethods[0]; // change to another type when desired for testing
                const isStoredPaymentMethodsEnabled =
                  await enabler.isStoredPaymentMethodsEnabled();

                let selectedStoredPaymentMethod = undefined;

                if (isStoredPaymentMethodSelected) {

                  builder = await enabler.createStoredPaymentMethodBuilder(
                    paymentMethodTypeToUseForSPM
                  );

                  const storedPaymentMethods =
                    await enabler.getStoredPaymentMethods({
                      allowedMethodTypes: allowedStoredPaymentMethods,
                    });

                  if (storedPaymentMethods.storedPaymentMethods.length === 0) {
                    console.warn("No stored payment methods for this customer");
                    return;
                  }

                  if (storedPaymentMethods.storedPaymentMethods.length === 1) {
                    selectedStoredPaymentMethod =
                      storedPaymentMethods.storedPaymentMethods[0];
                  } else {
                    for (const spm of storedPaymentMethods.storedPaymentMethods) {
                      {
                        const useSelectedOne = confirm(
                          `Use SPM with id ${spm.id} | "**** ${spm.displayOptions.endDigits} | ${spm.displayOptions.expiryMonth}/${spm.displayOptions.expiryYear}"`
                        );

                        if (useSelectedOne) {
                          selectedStoredPaymentMethod = spm;
                          break;
                        }
                      }
                    }
                  }

                  if (!selectedStoredPaymentMethod) {
                    console.warn(
                      "No stored payment method is selected to be used. Please select one"
                    );
                    return;
                  }

                  console.log(
                    "Selected stored payment method",
                    selectedStoredPaymentMethod
                  );

                  document
                    .getElementById("removeStorePaymentMethod-container")
                    .classList.remove("d-none");
                } else if (isDropIn) {
                  builder = await enabler.createDropinBuilder(selectedValue);
                } else if (isExpress) {
                  builder = await enabler.createExpressBuilder(selectedValue);
                } else {
                  builder = await enabler.createComponentBuilder(selectedValue);
                }

                // Only show the checkbox to store payment method if:
                // - not dropin this that has it's own way of storing a pm
                // - the user opted to pay with existing spm
                // - the selected payment method is in the allowed/supported list
                if (
                  !isDropIn &&
                  !isStoredPaymentMethodSelected &&
                  allowedStoredPaymentMethods.includes(selectedValue)
                ) {
                  document
                    .getElementById("storePaymentMethod-container")
                    .classList.remove("d-none");
                }

                const component = await builder.build({
                  ...(isStoredPaymentMethodSelected
                    ? {
                        id: selectedStoredPaymentMethod.id,
                        brands: [
                          selectedStoredPaymentMethod.displayOptions.brand.key,
                        ],
                      }
                    : {}),
                  showPayButton: !builder.componentHasSubmit,
                  ...(builder.componentHasSubmit
                    ? {}
                    : {
                        onPayButtonClick: async () => {
                          // to be used for validation
                          const termsChecked =
                            document.getElementById("termsCheckbox").checked;
                          if (!termsChecked) {
                            event.preventDefault();
                            alert(
                              "You must agree to the terms and conditions."
                            );
                            return Promise.reject("error-occurred");
                          }
                          return Promise.resolve(); // change to true, to test payment flow
                        },
                      }),
                      ...(isExpress ? {
                        onPaymentInit: async () => {
                          console.log("onPaymentInit event received");
                          return Promise.resolve();
                        },
                        onShippingAddressSelected: setShippingAddress,
                        getShippingMethods: getShippingMethods,
                        onShippingMethodSelected: setShippingMethod,
                        onPaymentSubmit: async (opts) => {
                          await setShippingAddress({ address: opts.shippingAddress });
                          await setBillingAddress({ address: opts.billingAddress });
                          return Promise.resolve();
                        },
                      } : {})
                });

                if (isStoredPaymentMethodSelected) {
                  document.getElementById("removeStorePaymentMethod").onclick =
                    function () {
                      const id = component.usedCocoStoredPaymentMethod.id;
                      component
                        .remove()
                        .then(() => {
                          alert(
                            "Deleted payment method with CT ID: '" +
                              id +
                              "'. Reload the Checkout to continue"
                          );
                        })
                        .catch((error) => {
                          alert(
                            "Failed to delete payment method with msg: " +
                              error.message
                          );
                        });
                    };
                }

                if (builder.componentHasSubmit) {
                  const methodsRequireMounting = [
                    "bancontactcard",
                    "bancontactmobile",
                    "blik",
                    "card",
                    "eps",
                    "fpx",
                    "ideal",
                    "klarna_billie",
                    "klarna_pay_later",
                    "klarna_pay_now",
                    "klarna_pay_overtime",
                    "przelewy24",
                    "sepadirectdebit",
                    "swish",
                    "twint",
                    "vipps",
                    "mobilepay",
                    "afterpay",
                    "clearpay",
                    "stored-payment-methods",
                  ];
                  const isAvailable = await component.isAvailable();
                  if (
                    isAvailable &&
                    methodsRequireMounting.includes(selectedValue)
                  ) {
                    await component.mount("#container--external");
                    const customButton = document.createElement("button");
                    customButton.textContent = "Pay with " + selectedValue;
                    customButton.className = "btn btn-lg btn-primary btn-block";
                    customButton.addEventListener("click", async () => {
                      const termsChecked =
                        document.getElementById("termsCheckbox").checked;
                      if (!termsChecked) {
                        event.preventDefault();
                        alert("You must agree to the terms and conditions.");
                        return;
                      }

                      const shouldStorePaymentMethod =
                        document.getElementById("storePaymentMethod").checked;

                      console.log(
                        "Should store/tokenise the payment method?",
                        shouldStorePaymentMethod
                      );

                      await component.submit({
                        storePaymentDetails: shouldStorePaymentMethod,
                      });
                    });
                    document
                      .getElementById("container--internal")
                      .appendChild(customButton);
                  } else {
                    console.error("Component not available", selectedValue);
                  }
                } else {
                  await component.mount("#container--external");
                }
              });
          </script>

          <div id="container--external"></div>

          <div class="form-group form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="termsCheckbox"
              required
            />
            <label class="form-check-label" for="termsCheckbox"
              >I agree to the terms and conditions</label
            >
          </div>

          <div
            id="storePaymentMethod-container"
            class="form-group form-check d-none"
          >
            <input
              type="checkbox"
              class="form-check-input"
              id="storePaymentMethod"
            />
            <label class="form-check-label" for="storePaymentMethod"
              >Check to store payment method</label
            >
          </div>

          <div
            id="removeStorePaymentMethod-container"
            class="form-group d-none"
          >
            <button
              id="removeStorePaymentMethod"
              type="button"
              class="btn btn-secondary btn-sm"
            >
              Click to remove this stored payment method
            </button>
          </div>

          <div id="container--internal"></div>
        </div>
      </div>
    </main>
  </body>
</html>
